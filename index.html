<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FINAL MISSION 3D</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap" rel="stylesheet">
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Black Ops One', cursive; touch-action: none; color: white; }
        .screen { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; background: rgba(0,0,0,0.9); }
        .btn { background: #00ff00; color: black; border: none; padding: 15px 50px; font-size: 22px; border-radius: 10px; cursor: pointer; font-weight: bold; margin: 10px; text-transform: uppercase; }
        #game-hud { position: absolute; top: 10px; width: 100%; display: none; justify-content: space-around; z-index: 50; font-size: 20px; color: #00ff00; pointer-events: none; text-shadow: 2px 2px #000; }
        #loading-screen { position: absolute; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 500; font-size: 25px; color: gold; }
    </style>
</head>
<body>

<div id="loading-screen">READY IN 1 SECOND...</div>

<div id="home-page" class="screen">
    <h1 style="color:#00ff00; font-size: 45px; text-align:center;">PRO RUNNER<br>ULTRA</h1>
    <p>BEST SCORE: <span id="best-score">0</span></p>
    <button class="btn" onclick="startGame()">START MISSION</button>
</div>

<div id="game-hud">
    <div>SCORE: <span id="current-score">0</span></div>
    <div style="color:#ff00ff;">GEMS: <span id="current-gems">0</span></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
let scene, camera, renderer, player, gameActive = false, score = 0, gems = 0;
let speed = 1.3, currentLane = 0, tiles = [], obstacles = [], items = [];
let isMagnet = false, magnetTimer = 0, monster;
const LANES = [-4, 0, 4];

// Database
let db = JSON.parse(localStorage.getItem('ultra_run_db')) || { best: 0, totalGems: 0 };

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050505);
    scene.fog = new THREE.FogExp2(0x050505, 0.015);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    let light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(5, 10, 5);
    scene.add(light);

    // 1. Player (No External Model - Instant Load)
    const pGeo = new THREE.BoxGeometry(1.2, 2.2, 1.2);
    const pMat = new THREE.MeshStandardMaterial({ color: 0x00ff00, emissive: 0x004400 });
    player = new THREE.Mesh(pGeo, pMat);
    player.position.y = 1.2;
    scene.add(player);

    // 2. Monster
    monster = new THREE.Mesh(new THREE.BoxGeometry(3, 6, 2), new THREE.MeshStandardMaterial({ color: 0xff0000, emissive: 0x440000 }));
    scene.add(monster);

    // 3. Initial Road
    for(let i=0; i<10; i++) createTile(i*30);

    // Controls
    let startX;
    window.addEventListener('touchstart', e => startX = e.touches[0].clientX);
    window.addEventListener('touchend', e => {
        let diff = e.changedTouches[0].clientX - startX;
        if(diff > 40) currentLane = Math.max(-1, currentLane - 1);
        if(diff < -40) currentLane = Math.min(1, currentLane + 1);
    });

    document.getElementById('loading-screen').style.display = 'none';
    document.getElementById('best-score').innerText = db.best;
    loop();
}

function createTile(z) {
    const tile = new THREE.Mesh(new THREE.BoxGeometry(14, 1, 30), new THREE.MeshStandardMaterial({ color: 0x222222 }));
    tile.position.set(0, 0, z);
    scene.add(tile);
    tiles.push(tile);

    if(z > 60) {
        if(Math.random() > 0.6) spawnObs(z);
        if(Math.random() > 0.5) spawnItem(z);
    }
}

function spawnObs(z) {
    const obs = new THREE.Mesh(new THREE.BoxGeometry(4, 2, 1), new THREE.MeshStandardMaterial({ color: 0xff4400 }));
    obs.position.set(LANES[Math.floor(Math.random()*3)], 1.5, z);
    scene.add(obs); obstacles.push(obs);
}

function spawnItem(z) {
    const isMag = Math.random() > 0.9;
    const item = new THREE.Mesh(isMag ? new THREE.TorusGeometry(0.5, 0.2) : new THREE.SphereGeometry(0.5), 
                 new THREE.MeshStandardMaterial({ color: isMag ? 0xff0000 : 0xffff00 }));
    item.position.set(LANES[Math.floor(Math.random()*3)], 1.5, z);
    item.userData = { type: isMag ? 'magnet' : 'coin' };
    scene.add(item); items.push(item);
}

function startGame() {
    document.getElementById('home-page').style.display = 'none';
    document.getElementById('game-hud').style.display = 'flex';
    gameActive = true;
}

function update() {
    if(!gameActive) return;

    player.position.z += speed;
    player.position.x += (LANES[currentLane+1] - player.position.x) * 0.15;
    score++;
    document.getElementById('current-score').innerText = score;

    monster.position.x += (player.position.x - monster.position.x) * 0.05;
    monster.position.z = player.position.z - 12;

    if(player.position.z > tiles[0].position.z + 30) {
        let t = tiles.shift(); t.position.z += tiles.length * 30 + 30;
        tiles.push(t); createTile(t.position.z);
    }

    items.forEach((it, i) => {
        if(isMagnet && it.userData.type === 'coin') it.position.lerp(player.position, 0.2);
        if(player.position.distanceTo(it.position) < 2) {
            if(it.userData.type === 'magnet') { isMagnet = true; magnetTimer = 400; }
            else { gems++; }
            scene.remove(it); items.splice(i, 1);
            document.getElementById('current-gems').innerText = gems;
        }
    });

    if(isMagnet) { magnetTimer--; if(magnetTimer<=0) isMagnet = false; }

    obstacles.forEach(ob => {
        if(player.position.distanceTo(ob.position) < 2) {
            gameActive = false;
            if(score > db.best) db.best = score;
            localStorage.setItem('ultra_run_db', JSON.stringify(db));
            alert("GAME OVER! SCORE: " + score);
            location.reload();
        }
    });
}

function loop() {
    requestAnimationFrame(loop);
    update();
    if(player) {
        camera.position.set(player.position.x * 0.5, 8, player.position.z - 14);
        camera.lookAt(0, 0, player.position.z + 10);
    }
    renderer.render(scene, camera);
}

window.onload = init;
</script>
</body>
</html>

